<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IRRè®¡ç®—å™¨ - æœ€ç»ˆç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            gap: 20px;
        }
        
        .progress-step {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            border-radius: 25px;
            background: rgba(255,255,255,0.2);
            transition: all 0.3s;
        }
        
        .progress-step.active {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }
        
        .progress-step.completed {
            background: rgba(76, 175, 80, 0.3);
        }
        
        .content {
            padding: 40px;
        }
        
        .step {
            display: none;
        }
        
        .step.active {
            display: block;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            border: 2px solid #f0f0f0;
            border-radius: 15px;
            background: #fafafa;
        }
        
        .section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4facfe;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f9f9f9;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #4facfe;
            background: #f0f8ff;
        }
        
        .upload-area.dragover {
            border-color: #4facfe;
            background: #e3f2fd;
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .data-preview {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        
        .data-table th {
            background: #f5f5f5;
            font-weight: 600;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-large {
            padding: 15px 30px;
            font-size: 18px;
        }
        
        .result-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .result-card h4 {
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .result-value {
            font-weight: 600;
            color: #4facfe;
        }
        
        .success-message, .error-message {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .hidden {
            display: none;
        }
        
        .negative-irr-info {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #ffeaa7;
        }
        
        @media (max-width: 768px) {
            .result-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§® IRRè®¡ç®—å™¨</h1>
            <p>ä¸“ä¸šä¿é™©æ–¹æ¡ˆå†…éƒ¨æ”¶ç›Šç‡è®¡ç®—å·¥å…·</p>
            
            <div class="progress-bar">
                <div class="progress-step active" id="step1-indicator">
                    <span>ğŸ“Š</span>
                    <span>è®¾ç½®å‚æ•°</span>
                </div>
                <div class="progress-step" id="step2-indicator">
                    <span>ğŸ“</span>
                    <span>ä¸Šä¼ æ•°æ®</span>
                </div>
                <div class="progress-step" id="step3-indicator">
                    <span>ğŸ“ˆ</span>
                    <span>æŸ¥çœ‹ç»“æœ</span>
                </div>
            </div>
        </div>
        
        <div class="content">
            <!-- æ­¥éª¤1: å‚æ•°è®¾ç½® -->
            <div class="step active" id="step1">
                <div class="section">
                    <h3>ğŸ’° ä¿è´¹å‚æ•°è®¾ç½®</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="payYears">ç¼´è´¹å¹´é™</label>
                            <input type="number" id="payYears" value="5" min="1" max="30">
                        </div>
                        <div class="form-group">
                            <label for="annualPremium">å¹´ç¼´é‡‘é¢ï¼ˆå…ƒï¼‰</label>
                            <input type="number" id="annualPremium" value="7000" min="0" step="0.01">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstYearDiscount">é¦–å¹´ä¿è´¹ä¼˜æƒ ï¼ˆå…ƒï¼‰</label>
                            <input type="number" id="firstYearDiscount" value="980" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="regulatoryFee">ç›‘ç®¡å±€å¾è´¹ï¼ˆå…ƒï¼‰</label>
                            <input type="number" id="regulatoryFee" value="7" min="0" step="0.01">
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>ğŸ“‹ ä¿è´¹ç°é‡‘æµé¢„è§ˆ</h3>
                    <p><strong>ç°é‡‘æµåºåˆ—ï¼š</strong><span id="cashFlowDisplay"></span></p>
                    <p><strong>æ€»ä¿è´¹æŠ•å…¥ï¼š</strong><span id="totalPremiumDisplay"></span></p>
                </div>
                
                <div style="text-align: center;">
                    <button class="btn btn-primary btn-large" onclick="goToStep(2)">
                        ä¸‹ä¸€æ­¥ï¼šä¸Šä¼ æ•°æ® â†’
                    </button>
                </div>
            </div>
            
            <!-- æ­¥éª¤2: æ•°æ®ä¸Šä¼  -->
            <div class="step" id="step2">
                <div class="section">
                    <h3>ğŸ“ ä¸Šä¼ æ•°æ®åº•ç¨¿</h3>
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                        <div class="upload-icon">ğŸ“Š</div>
                        <h4>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ Excelæ–‡ä»¶</h4>
                        <p>æ”¯æŒ .xlsx å’Œ .xls æ ¼å¼</p>
                        <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
                    </div>
                    <div id="uploadStatus" class="hidden"></div>
                </div>
                
                <div class="section" id="dataPreviewSection" style="display: none;">
                    <h3>ğŸ‘€ æ•°æ®é¢„è§ˆ</h3>
                    <div class="data-preview" id="dataPreview"></div>
                </div>
                
                <div style="text-align: center;">
                    <button class="btn btn-secondary" onclick="goToStep(1)">
                        â† è¿”å›å‚æ•°è®¾ç½®
                    </button>
                    <button class="btn btn-primary btn-large" id="calculateBtn" onclick="calculateIRRResults()" disabled>
                        ğŸ§® å¼€å§‹è®¡ç®—IRR
                    </button>
                </div>
            </div>
            
            <!-- æ­¥éª¤3: ç»“æœå±•ç¤º -->
            <div class="step" id="step3">
                <div class="result-grid">
                    <div>
                        <div class="result-card">
                            <h4>ğŸ“Š IRRè¶‹åŠ¿å›¾</h4>
                            <div class="chart-container">
                                <canvas id="irrChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="result-card">
                            <h4>ğŸ“‹ å…³é”®å¹´ä»½IRR</h4>
                            <div id="keyResults"></div>
                        </div>
                    </div>
                    
                    <div class="result-card">
                        <h4>ğŸ“„ è¯¦ç»†è®¡ç®—ç»“æœï¼ˆæ‰€æœ‰æ•°æ®è¡Œï¼‰</h4>
                        <div class="negative-irr-info">
                            <strong>è¯´æ˜ï¼š</strong>æ˜¾ç¤ºæ‰€æœ‰æ•°æ®è¡Œï¼ŒIRRä¸ºè´Ÿæ•°æ—¶æ˜¾ç¤ºä¸ºç©ºã€‚
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="data-table" id="resultsTable">
                                <thead>
                                    <tr>
                                                                <th>å¹´ä»½</th>
                        <th>æå–é‡‘é¢ï¼ˆå…ƒï¼‰</th>
                        <th>å·²æå–é‡‘é¢ç´¯è®¡ï¼ˆå…ƒï¼‰</th>
                        <th>æå–åæ€»ä»·å€¼ï¼ˆå…ƒï¼‰</th>
                        <th>ç°é‡‘æµæœŸæ•°</th>
                        <th>IRR (%)</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsTableBody"></tbody>
                            </table>
                        </div>
                        <div id="hiddenResultsInfo" class="negative-irr-info" style="display: none;">
                            è´Ÿæ•°IRRæ˜¾ç¤ºä¸ºç©º: <span id="hiddenCount">0</span> ä¸ªç»“æœ
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="goToStep(2)">
                        â† é‡æ–°ä¸Šä¼ æ•°æ®
                    </button>
                    <button class="btn btn-success btn-large" onclick="downloadExcel()">
                        ğŸ“¥ ä¸‹è½½ExcelæŠ¥å‘Š
                    </button>
                    <button class="btn btn-primary" onclick="goToStep(1)">
                        ğŸ”„ é‡æ–°è®¡ç®—
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let uploadedData = null;
        let calculationResults = null;
        let premiumCashFlow = [];
        let hiddenNegativeCount = 0;
        
        // IRRè®¡ç®—å‡½æ•°
        function calculateIRR(cashFlows) {
            function npv(rate) {
                return cashFlows.reduce((sum, cf, i) => sum + cf / Math.pow(1 + rate, i), 0);
            }
            
            let low = -0.99, high = 5.0;
            for (let i = 0; i < 1000; i++) {
                let mid = (low + high) / 2;
                if (Math.abs(npv(mid)) < 0.0001) return mid;
                npv(mid) > 0 ? low = mid : high = mid;
            }
            return mid;
        }
        
        // æ­¥éª¤åˆ‡æ¢
        function goToStep(stepNumber) {
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            
            document.querySelectorAll('.progress-step').forEach(step => {
                step.classList.remove('active');
            });
            
            document.getElementById(`step${stepNumber}`).classList.add('active');
            document.getElementById(`step${stepNumber}-indicator`).classList.add('active');
            
            for (let i = 1; i < stepNumber; i++) {
                document.getElementById(`step${i}-indicator`).classList.add('completed');
            }
        }
        
        // æ›´æ–°ä¿è´¹ç°é‡‘æµæ˜¾ç¤º
        function updatePremiumDisplay() {
            const payYears = parseInt(document.getElementById('payYears').value);
            const annualPremium = parseFloat(document.getElementById('annualPremium').value);
            const discount = parseFloat(document.getElementById('firstYearDiscount').value);
            const fee = parseFloat(document.getElementById('regulatoryFee').value);
            
            const firstYearPremium = annualPremium - discount + fee;
            premiumCashFlow = [-firstYearPremium];
            
            for (let i = 1; i < payYears; i++) {
                premiumCashFlow.push(-annualPremium);
            }
            
            const total = premiumCashFlow.reduce((sum, cf) => sum + Math.abs(cf), 0);
            
            document.getElementById('cashFlowDisplay').textContent = 
                '[' + premiumCashFlow.map(cf => cf.toLocaleString()).join(', ') + ']';
            document.getElementById('totalPremiumDisplay').textContent = 
                total.toLocaleString() + 'å…ƒ';
        }
        
        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
        }
        
        // å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶
        function handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showMessage('è¯·ä¸Šä¼ Excelæ–‡ä»¶ï¼', 'error');
                return;
            }
            
            showMessage('æ­£åœ¨è¯»å–æ–‡ä»¶...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    parseExcelData(jsonData);
                    showMessage('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼', 'success');
                    
                } catch (error) {
                    showMessage('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ï¼', 'error');
                    console.error('File reading error:', error);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // è§£æExcelæ•°æ®
        function parseExcelData(jsonData) {
            if (jsonData.length < 2) {
                showMessage('æ–‡ä»¶æ•°æ®ä¸è¶³ï¼', 'error');
                return;
            }
            
            // æŸ¥æ‰¾æ•°æ®å¼€å§‹è¡Œ
            let dataStartRow = -1;
            for (let i = 0; i < jsonData.length; i++) {
                const firstCell = jsonData[i][0];
                if (firstCell && !isNaN(firstCell) && parseInt(firstCell) >= 1) {
                    dataStartRow = i;
                    break;
                }
            }
            
            if (dataStartRow === -1) {
                showMessage('æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ•°æ®è¡Œï¼', 'error');
                return;
            }
            
            // å¤„ç†æ•°æ®
            uploadedData = [];
            for (let i = dataStartRow; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (row && row.length >= 6) {
                    const year = parseInt(row[0]);
                    const extractAmount = parseFloat(row[1]) || 0;
                    const finalValue = parseFloat(row[5]) || 0;
                    
                    if (year && finalValue > 0) {
                        uploadedData.push({
                            year: year,
                            extractAmount: extractAmount,
                            finalValue: finalValue
                        });
                    }
                }
            }
            
            if (uploadedData.length === 0) {
                showMessage('æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ•°æ®ï¼', 'error');
                return;
            }
            
            // æ˜¾ç¤ºæ•°æ®é¢„è§ˆ
            displayDataPreview();
            document.getElementById('calculateBtn').disabled = false;
        }
        
        // æ˜¾ç¤ºæ•°æ®é¢„è§ˆ
        function displayDataPreview() {
            const previewDiv = document.getElementById('dataPreview');
            const section = document.getElementById('dataPreviewSection');
            
            let html = '<table class="data-table"><thead><tr>';
            html += '<th>å¹´ä»½</th><th>æå–é‡‘é¢</th><th>æå–åæ€»ä»·å€¼</th>';
            html += '</tr></thead><tbody>';
            
            uploadedData.slice(0, 10).forEach(row => {
                html += `<tr>
                    <td>ç¬¬${row.year}å¹´</td>
                    <td>${row.extractAmount.toLocaleString()}</td>
                    <td>${row.finalValue.toLocaleString()}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            
            if (uploadedData.length > 10) {
                html += `<p style="text-align: center; margin-top: 10px;">
                    æ˜¾ç¤ºå‰10è¡Œï¼Œå…±${uploadedData.length}è¡Œæ•°æ®
                </p>`;
            }
            
            previewDiv.innerHTML = html;
            section.style.display = 'block';
        }
        
        // è®¡ç®—IRRç»“æœ
        function calculateIRRResults() {
            if (!uploadedData || uploadedData.length === 0) {
                showMessage('è¯·å…ˆä¸Šä¼ æ•°æ®ï¼', 'error');
                return;
            }
            
            showMessage('æ­£åœ¨è®¡ç®—IRR...', 'info');
            calculationResults = [];
            hiddenNegativeCount = 0;
            
            // è·å–æå–æ•°æ®
            const extractData = {};
            uploadedData.forEach(row => {
                if (row.extractAmount > 0) {
                    extractData[row.year] = row.extractAmount;
                }
            });
            
            // è®¡ç®—æ¯ä¸ªå¹´ä»½çš„IRR
            uploadedData.forEach(row => {
                const year = row.year;
                const finalValue = row.finalValue;
                
                if (finalValue > 0) {
                    // æ„å»ºç°é‡‘æµ
                    const cashFlows = [...premiumCashFlow];
                    
                    // è·å–è¯¥å¹´ä»½çš„æå–é‡‘é¢
                    const currentExtract = extractData[year] || 0;
                    
                    // è®¡ç®—ç´¯è®¡æå–é‡‘é¢
                    let cumulativeExtract = 0;
                    for (let y = 1; y <= year; y++) {
                        cumulativeExtract += extractData[y] || 0;
                    }
                    
                    // ç¬¬6å¹´åˆ°ç¬¬yearå¹´æœŸé—´çš„ç°é‡‘æµ
                    for (let y = premiumCashFlow.length + 1; y <= year; y++) {
                        if (extractData[y]) {
                            cashFlows.push(extractData[y]);
                        } else {
                            cashFlows.push(0);
                        }
                    }
                    
                    // æœ€åä¸€æœŸï¼šæå–åæ€»ä»·å€¼
                    cashFlows.push(finalValue);
                    
                    // è®¡ç®—IRR
                    let irr = null;
                    let irrDisplay = '';
                    try {
                        const irrValue = calculateIRR(cashFlows);
                        const irrPct = irrValue * 100;
                        
                        // æ˜¾ç¤ºæ‰€æœ‰è¡Œï¼Œè´Ÿæ•°IRRæ˜¾ç¤ºä¸ºç©º
                        if (irrPct > 0) {
                            irr = irrPct;
                            irrDisplay = irrPct.toFixed(2) + '%';
                        } else {
                            irr = null;
                            irrDisplay = '';
                            hiddenNegativeCount++;
                        }
                    } catch (error) {
                        irr = null;
                        irrDisplay = '';
                        hiddenNegativeCount++;
                    }
                    
                    // ä¿å­˜æ‰€æœ‰ç»“æœï¼ŒåŒ…æ‹¬è´Ÿæ•°IRR
                    calculationResults.push({
                        year: year,
                        extractAmount: currentExtract,
                        cumulativeExtract: cumulativeExtract,
                        finalValue: finalValue,
                        periods: cashFlows.length,
                        irr: irr,
                        irrDisplay: irrDisplay,
                        cashFlows: cashFlows
                    });
                }
            });
            
            displayResults();
            goToStep(3);
            
            showMessage(`æˆåŠŸå¤„ç†${calculationResults.length}è¡Œæ•°æ®ï¼`, 'success');
        }
        
        // æ˜¾ç¤ºç»“æœ - ä¿®æ”¹ç‰ˆæœ¬ï¼Œæ˜¾ç¤ºæ‰€æœ‰è¡Œï¼Œè´Ÿæ•°IRRä¸ºç©ºï¼Œå¢åŠ ç´¯è®¡æå–é‡‘é¢åˆ—
        function displayResults() {
            // æ˜¾ç¤ºè¯¦ç»†ç»“æœè¡¨æ ¼
            const tableBody = document.getElementById('resultsTableBody');
            tableBody.innerHTML = '';
            
            calculationResults.forEach(result => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>ç¬¬${result.year}å¹´</td>
                    <td>${result.extractAmount.toLocaleString()}</td>
                    <td>${result.cumulativeExtract.toLocaleString()}</td>
                    <td>${result.finalValue.toLocaleString()}</td>
                    <td>${result.periods}</td>
                    <td class="result-value">${result.irrDisplay}</td>
                `;
                tableBody.appendChild(tr);
            });
            
            // æ˜¾ç¤ºè´Ÿæ•°IRRç»Ÿè®¡
            if (hiddenNegativeCount > 0) {
                document.getElementById('hiddenCount').textContent = hiddenNegativeCount;
                document.getElementById('hiddenResultsInfo').style.display = 'block';
            }
            
            // æ˜¾ç¤ºå…³é”®å¹´ä»½ï¼ˆåªæ˜¾ç¤ºæœ‰æ•ˆIRRï¼‰
            const keyResults = document.getElementById('keyResults');
            keyResults.innerHTML = '';
            
            const keyYears = [5, 10, 15, 20, 25, 30, 35];
            keyYears.forEach(year => {
                const result = calculationResults.find(r => r.year === year && r.irr !== null);
                if (result) {
                    const div = document.createElement('div');
                    div.className = 'result-item';
                    const extractInfo = result.extractAmount > 0 ? ` (æå–: ${result.extractAmount.toLocaleString()}å…ƒ)` : '';
                    div.innerHTML = `
                        <span>ç¬¬${year}å¹´:</span>
                        <span class="result-value">${result.irr.toFixed(2)}%${extractInfo}</span>
                    `;
                    keyResults.appendChild(div);
                }
            });
            
            // ç»˜åˆ¶å›¾è¡¨
            drawChart();
        }
        
        // ç»˜åˆ¶IRRè¶‹åŠ¿å›¾
        function drawChart() {
            const ctx = document.getElementById('irrChart').getContext('2d');
            
            if (window.irrChartInstance) {
                window.irrChartInstance.destroy();
            }
            
            // åªæ˜¾ç¤ºæœ‰æ•ˆIRRçš„æ•°æ®ç‚¹
            const validResults = calculationResults.filter(r => r.irr !== null);
            const years = validResults.map(r => `ç¬¬${r.year}å¹´`);
            const irrs = validResults.map(r => r.irr);
            
            window.irrChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'IRR (%)',
                        data: irrs,
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#4facfe',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'IRRè¶‹åŠ¿åˆ†æï¼ˆä»…æ­£æ•°ç»“æœï¼‰',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'IRR (%)'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'å¹´ä»½'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }
        
        // ä¸‹è½½ExcelæŠ¥å‘Š
        function downloadExcel() {
            if (!calculationResults || calculationResults.length === 0) {
                showMessage('æ²¡æœ‰è®¡ç®—ç»“æœå¯ä»¥ä¸‹è½½ï¼', 'error');
                return;
            }
            
            // å‡†å¤‡æ•°æ®
            const wsData = [
                ['IRRè®¡ç®—æŠ¥å‘Šï¼ˆæ‰€æœ‰æ•°æ®è¡Œï¼‰'],
                [''],
                ['ä¿è´¹ä¿¡æ¯'],
                ['ä¿è´¹ç°é‡‘æµ', premiumCashFlow.join(', ')],
                ['æ€»ä¿è´¹æŠ•å…¥', premiumCashFlow.reduce((sum, cf) => sum + Math.abs(cf), 0).toLocaleString() + 'å…ƒ'],
                [''],
                ['è®¡ç®—ç»“æœè¯´æ˜'],
                ['æ˜¾ç¤ºæ‰€æœ‰æ•°æ®è¡Œï¼ŒIRRä¸ºè´Ÿæ•°æ—¶æ˜¾ç¤ºä¸ºç©º'],
                [`è´Ÿæ•°IRRç»“æœ: ${hiddenNegativeCount}ä¸ª`],
                [''],
                ['è¯¦ç»†è®¡ç®—ç»“æœ'],
                ['å¹´ä»½', 'æå–é‡‘é¢(å…ƒ)', 'å·²æå–é‡‘é¢ç´¯è®¡(å…ƒ)', 'æå–åæ€»ä»·å€¼(å…ƒ)', 'ç°é‡‘æµæœŸæ•°', 'IRR(%)']
            ];
            
            calculationResults.forEach(result => {
                wsData.push([
                    `ç¬¬${result.year}å¹´`,
                    result.extractAmount,
                    result.cumulativeExtract,
                    result.finalValue,
                    result.periods,
                    result.irrDisplay
                ]);
            });
            
            // åˆ›å»ºå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // è®¾ç½®åˆ—å®½
            ws['!cols'] = [
                {wch: 15}, {wch: 15}, {wch: 18}, {wch: 12}, {wch: 12}
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'IRRè®¡ç®—ç»“æœ');
            
            // ä¸‹è½½æ–‡ä»¶
            const fileName = `IRRè®¡ç®—æŠ¥å‘Š_å®Œæ•´ç»“æœ_${new Date().toISOString().slice(0, 10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showMessage('ExcelæŠ¥å‘Šä¸‹è½½æˆåŠŸï¼', 'success');
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type) {
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.className = type === 'error' ? 'error-message' : 
                                 type === 'success' ? 'success-message' : 
                                 'success-message';
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden');
            
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 3000);
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            ['payYears', 'annualPremium', 'firstYearDiscount', 'regulatoryFee'].forEach(id => {
                document.getElementById(id).addEventListener('input', updatePremiumDisplay);
            });
            
            // åˆå§‹åŒ–æ˜¾ç¤º
            updatePremiumDisplay();
            
            // è®¾ç½®æ–‡ä»¶ä¸Šä¼ 
            setupFileUpload();
        });
    </script>
</body>
</html> 